<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web网盘</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>☁️ Web网盘</h1>
                <p>安全、便捷的文件管理平台</p>
            </div>
            <div class="header-right">
                <div class="server-info" id="serverInfo">
                    <span>🌐 内网地址: 加载中...</span>
                </div>
                <div class="storage-info" id="storageInfo">
                    <span>📦 存储空间: 加载中...</span>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="toolbar">
                <button class="btn btn-success" onclick="showUploadModal()">
                    📤 上传文件
                </button>
                <button class="btn" onclick="showCreateFolderModal()">
                    📁 新建文件夹
                </button>
                <button class="btn btn-secondary" onclick="loadTree()">
                    🔄 刷新
                </button>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜索文件或文件夹...">
                    <div class="search-icon">🔍</div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="current-folder" id="currentFolder" style="display: none;">
                    当前文件夹: <span id="currentFolderPath">/</span>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div class="file-browser" id="fileBrowser">
                <div class="drop-zone" id="rootDropZone" style="display: none;">
                    📁 拖放到此处移动到根目录
                </div>
                <div class="loading">
                    <div class="spinner"></div>
                    加载中...
                </div>
            </div>
        </div>
    </div>

    <!-- 上传文件模态框 -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">上传文件</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择文件</label>
                    <input type="file" id="fileInput" class="form-input" multiple>
                </div>
                <div class="form-group">
                    <label class="form-label">上传到文件夹</label>
                    <select id="uploadFolderSelect" class="form-select">
                        <option value="">根目录</option>
                    </select>
                </div>
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-text" id="progressText">准备上传...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('uploadModal')">取消</button>
                <button class="btn btn-success" onclick="startUpload()">上传</button>
            </div>
        </div>
    </div>

    <!-- 创建文件夹模态框 -->
    <div class="modal" id="createFolderModal">
        <div class="modal-content">
            <div class="modal-header">创建文件夹</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">文件夹名称</label>
                    <input type="text" id="folderNameInput" class="form-input" placeholder="请输入文件夹名称">
                </div>
                <div class="form-group">
                    <label class="form-label">创建位置</label>
                    <select id="createFolderSelect" class="form-select">
                        <option value="">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createFolderModal')">取消</button>
                <button class="btn" onclick="createFolder()">创建</button>
            </div>
        </div>
    </div>

    <!-- 移动文件模态框 -->
    <div class="modal" id="moveModal">
        <div class="modal-content">
            <div class="modal-header">移动文件/文件夹</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">移动到</label>
                    <select id="moveTargetSelect" class="form-select">
                        <option value="">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('moveModal')">取消</button>
                <button class="btn" onclick="moveItem()">移动</button>
            </div>
        </div>
    </div>

    <!-- 重命名模态框 -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">重命名</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" id="renameLabel">新名称</label>
                    <input type="text" id="renameInput" class="form-input" placeholder="请输入新名称">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('renameModal')">取消</button>
                <button class="btn" onclick="renameItem()">确定</button>
            </div>
        </div>
    </div>

    <!-- 创建文件模态框 -->
    <div class="modal" id="createFileModal">
        <div class="modal-content">
            <div class="modal-header">创建文件</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">文件名称</label>
                    <input type="text" id="fileNameInput" class="form-input" placeholder="请输入文件名称">
                </div>
                <div class="form-group">
                    <label class="form-label">创建位置</label>
                    <select id="createFileFolderSelect" class="form-select">
                        <option value="">根目录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createFileModal')">取消</button>
                <button class="btn" onclick="createFile()">创建</button>
            </div>
        </div>
    </div>

    <!-- 图像编辑模态框 -->
    <div class="modal image-editor-modal" id="imageEditorModal">
        <div class="modal-content image-editor-content">
            <div class="modal-header">
                <span>图像编辑</span>
                <button class="modal-close" onclick="closeImageEditor()">×</button>
            </div>
            <div class="image-editor-body">
                <div class="image-editor-sidebar">
                    <div class="editor-tool-section">
                        <h3>工具</h3>
                        <div class="tool-buttons">
                            <button class="tool-btn active" data-tool="crop" onclick="setEditorTool('crop')">
                                <span>✂️</span> 裁剪
                            </button>
                            <button class="tool-btn" data-tool="perspective" onclick="setEditorTool('perspective')">
                                <span>📐</span> 透视变换
                            </button>
                            <button class="tool-btn" data-tool="text" onclick="setEditorTool('text')">
                                <span>📝</span> 文字
                            </button>
                            <button class="tool-btn" data-tool="arrow" onclick="setEditorTool('arrow')">
                                <span>➡️</span> 箭头
                            </button>
                            <button class="tool-btn" data-tool="mosaic" onclick="setEditorTool('mosaic')">
                                <span>🖌️</span> 涂抹
                            </button>
                        </div>
                    </div>

                    <!-- 裁剪工具选项 -->
                    <div class="tool-options" id="cropOptions" style="display: none;">
                        <h4>裁剪选项</h4>
                        <div class="form-group">
                            <label>固定比例</label>
                            <select id="cropRatio" class="form-select" onchange="updateCropRatio()">
                                <option value="free">自由裁剪</option>
                                <option value="1:1">1:1 (正方形)</option>
                                <option value="4:3">4:3</option>
                                <option value="3:4">3:4</option>
                                <option value="16:9">16:9</option>
                                <option value="9:16">9:16</option>
                                <option value="3:2">3:2</option>
                                <option value="2:3">2:3</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn btn-sm" onclick="applyCrop()">应用裁剪 (Enter)</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelCrop()">取消 (Esc)</button>
                        </div>
                    </div>

                    <!-- 透视变换工具选项 -->
                    <div class="tool-options" id="perspectiveOptions" style="display: none;">
                        <h4>透视变换</h4>
                        <p>点击图片的4个角进行标记</p>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn btn-sm" onclick="applyPerspective()">应用变换 (Enter)</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelPerspective()">取消 (Esc)</button>
                        </div>
                    </div>

                    <!-- 文字工具选项 -->
                    <div class="tool-options" id="textOptions" style="display: none;">
                        <h4>文字选项</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">在图片上点击位置添加文字，点击文字后拖拽可移动</p>
                        <div class="form-group">
                            <label>文字内容</label>
                            <input type="text" id="textContent" class="form-input" placeholder="输入文字" value="示例文字" onchange="addTextToCanvas()">
                        </div>
                        <div class="form-group">
                            <label>字体</label>
                            <select id="textFont" class="form-select" onchange="addTextToCanvas()">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Georgia">Georgia</option>
                                <option value="微软雅黑">微软雅黑</option>
                                <option value="宋体">宋体</option>
                                <option value="黑体">黑体</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>字号</label>
                            <input type="number" id="textSize" class="form-input" min="10" max="200" value="24" onchange="addTextToCanvas()">
                        </div>
                        <div class="form-group">
                            <label>颜色</label>
                            <input type="color" class="form-input color-input" data-tool="text" data-default="#000000" value="#000000" onchange="updateToolColor('text', this.value); addTextToCanvas();">
                        </div>
                    </div>

                    <!-- 箭头工具选项 -->
                    <div class="tool-options" id="arrowOptions" style="display: none;">
                        <h4>箭头选项</h4>
                        <div class="form-group">
                            <label>箭头类型</label>
                            <select id="arrowType" class="form-select">
                                <option value="simple">简单箭头</option>
                                <option value="filled">实心箭头</option>
                                <option value="double">双箭头</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>颜色</label>
                            <input type="color" class="form-input color-input" data-tool="arrow" data-default="#ff0000" value="#ff0000" onchange="updateToolColor('arrow', this.value);">
                        </div>
                        <div class="form-group size-control-group" data-tool="arrow">
                            <label>大小</label>
                            <div class="size-radio-container">
                                <div class="size-radio-group">
                                    <label class="size-radio-label">
                                        <input type="radio" name="arrowSizeRadio" value="5" checked onclick="updateToolSize(5);">
                                        <span class="size-radio-circle" style="width: 5px; height: 5px;"></span>
                                    </label>
                                    <label class="size-radio-label">
                                        <input type="radio" name="arrowSizeRadio" value="10" onclick="updateToolSize(10);">
                                        <span class="size-radio-circle" style="width: 10px; height: 10px;"></span>
                                    </label>
                                    <label class="size-radio-label">
                                        <input type="radio" name="arrowSizeRadio" value="20" onclick="updateToolSize(20);">
                                        <span class="size-radio-circle" style="width: 20px; height: 20px;"></span>
                                    </label>
                                </div>
                                <div class="size-custom-group">
                                    <label class="size-custom-label">自定义:</label>
                                    <input type="number" class="form-input size-input" min="1" max="100" value="5" onchange="updateToolSizeFromInput();" oninput="updateToolSizeFromInput();">
                                    <span class="size-unit">px</span>
                                </div>
                            </div>
                        </div>
                        <p>在图片上拖拽绘制箭头</p>
                    </div>

                    <!-- 涂抹工具选项 -->
                    <div class="tool-options" id="mosaicOptions" style="display: none;">
                        <h4>涂抹选项</h4>
                        <div class="form-group">
                            <label>画笔颜色</label>
                            <input type="color" class="form-input color-input" data-tool="mosaic" data-default="#000000" value="#000000" onchange="updateToolColor('mosaic', this.value);">
                        </div>
                        <div class="form-group size-control-group" data-tool="mosaic">
                            <label>画笔粗细</label>
                            <div class="size-radio-container">
                                <div class="size-radio-group">
                                    <label class="size-radio-label">
                                        <input type="radio" name="mosaicSizeRadio" value="5" checked onclick="updateToolSize(5);">
                                        <span class="size-radio-circle" style="width: 5px; height: 5px;"></span>
                                    </label>
                                    <label class="size-radio-label">
                                        <input type="radio" name="mosaicSizeRadio" value="10" onclick="updateToolSize(10);">
                                        <span class="size-radio-circle" style="width: 10px; height: 10px;"></span>
                                    </label>
                                    <label class="size-radio-label">
                                        <input type="radio" name="mosaicSizeRadio" value="20" onclick="updateToolSize(20);">
                                        <span class="size-radio-circle" style="width: 20px; height: 20px;"></span>
                                    </label>
                                </div>
                                <div class="size-custom-group">
                                    <label class="size-custom-label">自定义:</label>
                                    <input type="number" class="form-input size-input" min="1" max="100" value="5" onchange="updateToolSizeFromInput();" oninput="updateToolSizeFromInput();">
                                    <span class="size-unit">px</span>
                                </div>
                            </div>
                        </div>
                        <p>在图片上按住鼠标拖动进行涂抹</p>
                    </div>
                </div>

                <div class="image-editor-main">
                    <div class="editor-canvas-container">
                        <canvas id="editorCanvas"></canvas>
                        <input type="text" id="textEditorInput" class="text-editor-input" style="display: none; position: absolute; border: 2px solid #667eea; padding: 5px; font-size: 16px; background: rgba(255,255,255,0.9);">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm" onclick="undoEdit()" title="撤销 (Ctrl+Z)">↶ 撤销</button>
                    <button class="btn btn-sm" onclick="redoEdit()" title="前进 (Ctrl+Shift+Z)">↷ 前进</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeImageEditor()">取消</button>
                    <button class="btn" onclick="resetImageEditor()">重置</button>
                    <button class="btn btn-success" onclick="saveEditedImage()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="menuCreateFile" onclick="contextMenuCreateFile()">
            <span>📄</span>
            <span>新建文件</span>
        </div>
        <div class="context-menu-item" id="menuCreateFolder" onclick="contextMenuCreateFolder()">
            <span>📁</span>
            <span>新建文件夹</span>
        </div>
        <div class="context-menu-divider" id="menuDivider1"></div>
        <div class="context-menu-item" id="menuRename" onclick="contextMenuRename()">
            <span>✏️</span>
            <span>重命名</span>
        </div>
        <div class="context-menu-item" id="menuMove" onclick="contextMenuMove()">
            <span>📦</span>
            <span>移动</span>
        </div>
        <div class="context-menu-item" id="menuEditImage" onclick="contextMenuEditImage()">
            <span>✂️</span>
            <span>编辑图片</span>
        </div>
        <div class="context-menu-item" id="menuPdfToJpg" onclick="contextMenuPdfToJpg()">
            <span>🖼️</span>
            <span>导出为JPG</span>
        </div>
        <div class="context-menu-divider" id="menuDivider2"></div>
        <div class="context-menu-item" id="menuRestore" onclick="contextMenuRestore()">
            <span>♻️</span>
            <span>恢复</span>
        </div>
        <div class="context-menu-item" id="menuRestoreAll" onclick="contextMenuRestoreAll()">
            <span>🔄</span>
            <span>一键恢复</span>
        </div>
        <div class="context-menu-item" id="menuEmptyTrash" onclick="contextMenuEmptyTrash()">
            <span>🗑️</span>
            <span>清空回收站</span>
        </div>
        <div class="context-menu-item danger" id="menuDelete" onclick="contextMenuDelete()">
            <span>🗑️</span>
            <span>删除</span>
        </div>
        <div class="context-menu-item danger" id="menuPermanentDelete" onclick="contextMenuPermanentDelete()">
            <span>⚠️</span>
            <span>永久删除</span>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>


